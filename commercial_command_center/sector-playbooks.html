<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sector Risk Playbooks</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="js/accessControl.js"></script>
    <script>
      restrict(["platformOwner", "strategy", "executive", "underwriting"]);
    </script>
  </head>

  <body class="bg-slate-100 text-slate-900 p-8">
    <h2 class="text-xl font-semibold mb-6">
      Sector Risk Playbooks & Appetite Signals
    </h2>

    <table class="bg-white w-full border rounded shadow">
      <thead>
        <tr class="border-b bg-slate-50">
          <th class="p-3 text-left">Sector</th>
          <th class="p-3 text-right">Total GWP</th>
          <th class="p-3 text-right">Avg Loss Ratio</th>
          <th class="p-3 text-center">Appetite</th>
          <th class="p-3 text-left">Playbook Guidance</th>
        </tr>
      </thead>
      <tbody id="sectorRows"></tbody>
    </table>

    <script src="js/dataStore.js"></script>
    <script>
      const data = getPortfolioData();
      const tbody = document.getElementById("sectorRows");

      // --- STEP 1: GROUP BY SECTOR ---
      const sectors = {};

      data.forEach((r) => {
        const sector = r.Sector || "Unknown";

        if (!sectors[sector]) {
          sectors[sector] = {
            sector,
            totalGWP: 0,
            totalClaims: 0,
            count: 0,
          };
        }

        sectors[sector].totalGWP += toNumber(r.GWP);
        sectors[sector].totalClaims +=
          toNumber(r.ClaimsPaid) + toNumber(r.ClaimsOutstanding);
        sectors[sector].count += 1;
      });

      // --- STEP 2: RENDER PLAYBOOKS ---
      Object.values(sectors).forEach((s) => {
        const avgLossRatio =
          s.totalGWP === 0 ? 0 : (s.totalClaims / s.totalGWP) * 100;

        let appetite = "ðŸŸ¢ Growth";
        let playbook =
          "Expand cautiously. Standard terms. Focus on profitable sub-segments.";
        let rowClass = "bg-green-50";

        if (avgLossRatio > 80) {
          appetite = "ðŸ”´ Defensive";
          playbook =
            "Restrict exposure. Tighten underwriting. Higher deductibles and pricing discipline required.";
          rowClass = "bg-red-50";
        } else if (avgLossRatio > 65) {
          appetite = "ðŸŸ¡ Cautious";
          playbook =
            "Selective growth. Tighten wordings. Prefer experienced insureds and risk-mitigated accounts.";
          rowClass = "bg-orange-50";
        }

        const tr = document.createElement("tr");
        tr.className = `border-b ${rowClass}`;
        tr.innerHTML = `
      <td class="p-3 font-medium">${s.sector}</td>
      <td class="p-3 text-right">${s.totalGWP.toLocaleString()}</td>
      <td class="p-3 text-right">${avgLossRatio.toFixed(1)}%</td>
      <td class="p-3 text-center font-semibold">${appetite}</td>
      <td class="p-3">${playbook}</td>
    `;
        tbody.appendChild(tr);
      });
    </script>
  </body>
</html>
