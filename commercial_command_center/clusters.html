<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cluster Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="js/accessControl.js"></script>
    <script>
      restrict(["platformOwner", "strategy", "executive", "underwriting"]);
    </script>
  </head>

  <body class="bg-slate-100 text-slate-900 p-8">
    <h2 class="text-xl font-semibold mb-6">
      Cluster Intelligence & Portfolio Signals
    </h2>

    <table class="bg-white w-full border rounded shadow">
      <thead>
        <tr class="border-b bg-slate-50">
          <th class="p-3 text-left">Cluster</th>
          <th class="p-3 text-left">Sector</th>
          <th class="p-3 text-right">Total GWP</th>
          <th class="p-3 text-right">Avg Loss Ratio</th>
          <th class="p-3 text-right">Avg Capacity Used</th>
          <th class="p-3 text-center">Signal</th>
        </tr>
      </thead>
      <tbody id="clusterRows"></tbody>
    </table>

    <script src="js/dataStore.js"></script>
    <script>
      const data = getPortfolioData();
      const tbody = document.getElementById("clusterRows");

      // --- STEP 1: GROUP DATA BY CLUSTER ---
      const clusters = {};

      data.forEach((r) => {
        const cluster = r.Cluster || "Unknown";
        const sector = r.Sector || "Unknown";

        if (!clusters[cluster]) {
          clusters[cluster] = {
            cluster,
            sector,
            totalGWP: 0,
            totalClaims: 0,
            totalCapacity: 0,
            count: 0,
          };
        }

        clusters[cluster].totalGWP += toNumber(r.GWP);
        clusters[cluster].totalClaims +=
          toNumber(r.ClaimsPaid) + toNumber(r.ClaimsOutstanding);
        clusters[cluster].totalCapacity += toNumber(r.CapacityUsed);
        clusters[cluster].count += 1;
      });

      // --- STEP 2: RENDER TABLE ---
      Object.values(clusters).forEach((c) => {
        const avgLossRatio =
          c.totalGWP === 0 ? 0 : (c.totalClaims / c.totalGWP) * 100;
        const avgCapacity = c.count === 0 ? 0 : c.totalCapacity / c.count;

        let signal = "ðŸŸ¢ Expand";
        let signalClass = "text-green-600";

        if (avgLossRatio > 80 || avgCapacity > 90) {
          signal = "ðŸ”´ Exit / Restrict";
          signalClass = "text-red-600";
        } else if (avgLossRatio > 65 || avgCapacity > 80) {
          signal = "ðŸŸ¡ Hold / Tighten";
          signalClass = "text-orange-600";
        }

        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-slate-50";
        tr.innerHTML = `
      <td class="p-3">${c.cluster}</td>
      <td class="p-3">${c.sector}</td>
      <td class="p-3 text-right">${c.totalGWP.toLocaleString()}</td>
      <td class="p-3 text-right">${avgLossRatio.toFixed(1)}%</td>
      <td class="p-3 text-right">${avgCapacity.toFixed(0)}%</td>
      <td class="p-3 text-center font-semibold ${signalClass}">
        ${signal}
      </td>
    `;
        tbody.appendChild(tr);
      });
    </script>
  </body>
</html>
