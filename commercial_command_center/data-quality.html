<!doctype html>
<html>
  <head>
    <title>Data Quality Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="js/accessControl.js"></script>
    <script>
      restrict(["platformOwner", "strategy", "dataSteward"]);
    </script>
  </head>

  <body class="bg-slate-100 p-8">
    <h2 class="text-xl font-semibold mb-4">Data Quality & Ingestion Monitor</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <p class="text-sm text-slate-500">Rows Loaded</p>
        <p id="rowCount" class="text-2xl font-bold"></p>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <p class="text-sm text-slate-500">Zero / Missing GWP</p>
        <p id="zeroGwp" class="text-2xl font-bold text-red-600"></p>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <p class="text-sm text-slate-500">High Loss Ratio (&gt;100%)</p>
        <p id="highLR" class="text-2xl font-bold text-orange-600"></p>
      </div>
    </div>

    <table class="bg-white w-full border">
      <thead>
        <tr class="border-b">
          <th class="p-2">Sector</th>
          <th class="p-2">Cluster</th>
          <th class="p-2">GWP</th>
          <th class="p-2">Loss Ratio</th>
          <th class="p-2">Status</th>
        </tr>
      </thead>
      <tbody id="qualityRows"></tbody>
    </table>

    <script src="js/dataStore.js"></script>
    <script>
      const data = getPortfolioData();
      const tbody = document.getElementById("qualityRows");

      document.getElementById("rowCount").innerText = data.length;

      let zeroGwpCount = 0;
      let highLRCount = 0;

      data.forEach((r) => {
        const gwp = toNumber(r.GWP);
        const lr = calculateLossRatio(r);

        let status = "✅ OK";
        let statusClass = "text-green-600";

        if (gwp === 0) {
          status = "❌ Missing / Zero GWP";
          statusClass = "text-red-600";
          zeroGwpCount++;
        } else if (lr > 100) {
          status = "⚠️ Extreme Loss Ratio";
          statusClass = "text-orange-600";
          highLRCount++;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td class="p-2">${r.Sector}</td>
      <td class="p-2">${r.Cluster}</td>
      <td class="p-2">${gwp}</td>
      <td class="p-2">${lr.toFixed(1)}%</td>
      <td class="p-2 ${statusClass}">${status}</td>
    `;
        tbody.appendChild(tr);
      });

      document.getElementById("zeroGwp").innerText = zeroGwpCount;
      document.getElementById("highLR").innerText = highLRCount;
    </script>
  </body>
</html>
