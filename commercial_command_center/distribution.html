<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Distribution Guidance</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="js/accessControl.js"></script>
    <script>
      restrict([
        "platformOwner",
        "strategy",
        "executive",
        "underwriting",
        "distribution",
      ]);
    </script>
  </head>

  <body class="bg-slate-100 text-slate-900 p-8">
    <h2 class="text-xl font-semibold mb-6">
      Distribution Guidance â€” Where to Push, Hold, or Pause
    </h2>

    <table class="bg-white w-full border rounded shadow">
      <thead>
        <tr class="border-b bg-slate-50">
          <th class="p-3 text-left">Cluster</th>
          <th class="p-3 text-left">Sector</th>
          <th class="p-3 text-center">Signal</th>
          <th class="p-3 text-left">Distribution Instruction</th>
        </tr>
      </thead>
      <tbody id="distRows"></tbody>
    </table>

    <script src="js/dataStore.js"></script>
    <script>
      const data = getPortfolioData();
      const tbody = document.getElementById("distRows");

      // --- REBUILD CLUSTER SIGNALS (SAME LOGIC AS clusters.html) ---
      const clusters = {};

      data.forEach((r) => {
        const cluster = r.Cluster || "Unknown";
        const sector = r.Sector || "Unknown";

        if (!clusters[cluster]) {
          clusters[cluster] = {
            cluster,
            sector,
            totalGWP: 0,
            totalClaims: 0,
            totalCapacity: 0,
            count: 0,
          };
        }

        clusters[cluster].totalGWP += toNumber(r.GWP);
        clusters[cluster].totalClaims +=
          toNumber(r.ClaimsPaid) + toNumber(r.ClaimsOutstanding);
        clusters[cluster].totalCapacity += toNumber(r.CapacityUsed);
        clusters[cluster].count += 1;
      });

      Object.values(clusters).forEach((c) => {
        const avgLossRatio =
          c.totalGWP === 0 ? 0 : (c.totalClaims / c.totalGWP) * 100;
        const avgCapacity = c.count === 0 ? 0 : c.totalCapacity / c.count;

        let signal = "ðŸŸ¢ Expand";
        let instruction =
          "Push aggressively. Increase outreach and broker focus.";
        let rowClass = "bg-green-50";

        if (avgLossRatio > 80 || avgCapacity > 90) {
          signal = "ðŸ”´ Restrict";
          instruction =
            "Pause new business. Allow renewals only with underwriting approval.";
          rowClass = "bg-red-50";
        } else if (avgLossRatio > 65 || avgCapacity > 80) {
          signal = "ðŸŸ¡ Hold";
          instruction =
            "Sell selectively. Tighten terms and pricing discipline.";
          rowClass = "bg-orange-50";
        }

        const tr = document.createElement("tr");
        tr.className = `border-b ${rowClass}`;
        tr.innerHTML = `
      <td class="p-3">${c.cluster}</td>
      <td class="p-3">${c.sector}</td>
      <td class="p-3 text-center font-semibold">${signal}</td>
      <td class="p-3">${instruction}</td>
    `;
        tbody.appendChild(tr);
      });
    </script>
  </body>
</html>
